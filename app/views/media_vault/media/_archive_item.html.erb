<% caption_is_collapsable = archive_item_caption.present? && archive_item_caption.length > 320 %>
<% include_author = true unless defined?(include_author) && include_author == false %>
<%
  archive_item_class_list = generate_class_list_string({
    "archive-item": true,
    "archive-item--boxed": defined?(boxed) && boxed == true,
  })
%>

<div
    class="<%= archive_item_class_list %>"
    data-publishing-platform="<%= publishing_platform_shortname %>"
    data-controller="media-vault--archive"
    data-media-vault--archive-caption-collapse-mode-value="<%= caption_is_collapsable ? 'collapsed' : 'static' %>"
>
  <div class="archive-item__inner">
    <% if include_author %>
      <%= link_to author_canonical_path,
          class: "author",
          title: "MediaVault profile page for #{author_display_name}" do %>
          <img
              class="author__image"
              src="<%= author_profile_image_url %>"
              alt="Profile photo for <%= author_display_name %>"
          />
          <div class="author__profile">
            <div class="author__name">
                <span class="author__display-name"><%= author_display_name %></span>
                <% unless author_username.nil? %>
                    <span class="author__username">@<%= author_username %></span>
                <% end %>
            </div>
            <div class="author__metadata">
                <%= abbreviate_number(author_community_count) %>
                <%= author_community_noun.pluralize(author_community_count) %>
            </div>
          </div>
      <% end %>
    <% end %>
    <div class="archive-item__body">
        <% if archive_item_self.has_displayable_media? %>
            <div class="archive-item__body-media">
                <% if archive_item_self.combined_media.length == 1 %>
                    <%= render partial: "media_vault/media/archive_item_medium", locals: { media: archive_item_self.combined_media.first } %>
                <% else %>
                    <%= render partial: "media_vault/media/archive_item_medium_thumbnails", locals: { combined_media: archive_item_self.combined_media } %>
                <% end %>
            </div>
        <% end %>
        <div class="archive-item__body-caption">
            <div
                class="archive-item__body-caption-content"
                data-media-vault--archive-target="captionContent"
            >
                <%= linkify_urls_in_text(simple_format(archive_item_caption)) %>
            </div>
            <% if caption_is_collapsable %>
                <button
                    class="archive-item__body-caption-toggler"
                    data-media-vault--archive-target="captionToggler"
                    data-action="media-vault--archive#toggleCaption"
                    data-collapse-label="Collapse caption ↑"
                    data-expand-label="Expand caption ↓"
                >Expand caption ↓</button>
            <% end %>
        </div>
    </div>
    <div class="archive-item__metadata justify-between">
        <div class="flex justify-start space-x-4">
            <div class="icon-prefixed">
              <%= use_svg publishing_platform_shortname, svg_attrs: { class: "icon", aria: { hidden: true } } %>
              <div class="archive-item__metadatum">
                  <div class="archive-item__metadatum__label">Published on <%= publishing_platform_display_name %></div>
                  <time
                      class="archive-item__metadatum__value"
                      datetime="<%= published_at.iso8601 %>"
                      data-media-vault--archive-target="timestamp"
                  >
                      <%= published_at %>
                  </time>
              </div>
            </div>
            <%= link_to media_vault_medium_path(archive_item_self.archive_item), class: "archive-item__metadatum" do %>
                <div class="archive-item__metadatum__label">Archived</div>
                <time
                    class="archive-item__metadatum__value"
                    datetime="<%= archived_at.iso8601 %>"
                    data-media-vault--archive-target="timestamp"
                >
                    <%= archived_at %>
                </time>
            <% end %>
        </div>
        <div class="flex items-center flex-col">
            <%= link_to media_vault_medium_path(archive_item_self.archive_item) do %>
              <div class="archive-item__download__link">View media detail</div>
            <% end %>
            <%= link_to media_vault_export_media_metadata_path(archive_item_self.archive_item.id) do %>
              <div class="archive-item__download__link">Download media metadata</div>
            <% end %>
        </div>
    </div>
  </div>
</div>
